# My operating system ABI

The most important part of our operating system is IPC, since it's a microkernel. The ABI is the interface between the kernel and the userland. It's the most important part of the operating system, since it's the only way to communicate with the kernel.

For a service program, we need to use `request`, `receive` and `respond` to communicate with the kernel. For a client program, we just need to use the normal Unix system calls. The kernel will automatically handle the IPC for us.

## IPC concepts

### handle

A handle is the only marker of a service. For service holder, it should hold the handle to provide service. When responding, the handle should be passed to the kernel to wake up the blocking request.

A handle will only be generated by the kernel for each blocking request. It's unique and positive. If the handle is **0**, it means the service requires no response, so we should not fall into a kernel trap. If the handle is **negative**, it means that the service we received is incomplete. This is possibly due to the fact that the buffer is too small to hold the whole message, and the value is the negative of rest size of the message in bytes.

## IPC functions

### `request`

Request input 7 arguments:

1. `a0 ~ a2`: The first 3 arguments, just like simple system calls.
2. `a4`: The service kind with respect to the service program.
3. `a5`: Whether the request is blocking or not.
4. `a6`: The service port number.
5. `a7`: System call number.

It will return only one argument, which is the return value of the system call.

### `receive`

Receive input 5 arguments:

1. `a0 ~ a2`: The first 3 arguments, just like simple system calls.
2. `a6`: The service port number.
3. `a7`: System call number.

### `respond`

Respond input 2 arguments:

1. `a5`: The service handle.
2. `a7`: System call number.

It will wake up the blocking request. Specially, if the `a5` is 0, it will not wake up any request, which marks an asynchronous response. This will not involve any system call.
